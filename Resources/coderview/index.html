<!doctype html>
<html>
  <head>
    <title>Network | Multifont Labels</title>
    <script type="text/javascript" src="./js/vis.min.js"></script>
    <link href="./css/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">#mynetwork { width: 100%; height: 100%; border: 1px solid lightgray; } code { font-size: 15px; } p { max-width: 600px; } .indented { margin-left: 30px; } table { border-collapse: collapse; font-family: sans-serif; } table code { background: #dddddd; } th, td { border: 1px solid #aaaaaa; text-align: center; padding: 5px; font-weight: normal; }</style></head>
  <body>
    <input type="button" style="width:80px;height:30px;" draggable="true" ondragstart="drag(event)" value="drag"></input>
    <div id="mynetwork" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <pre id="eventSpan"></pre>
    <script type="text/javascript" src="../timeline/media/js/jquery.js"></script>
    <script type="text/javascript">
      //定义需要生成的节点
      var allnodes = [
		    /*{ id: 1, label: 'Coder1', margin: {top: 10, right: 20, bottom: 10, left: 30}, x: -120, y: -100 },
		    { id: 2, font: { multi: true}, label: 'property1', x: 0, y: -120, color: 'rgb(255,168,7)'},
		    { id: 3, font: { multi: 'html', size: 10 }, label: 'property2', x: 0, y: -80, color: 'rgb(255,168,7)'},
	    	{ id: 4, font: { multi: 'md', face: 'georgia' }, margin: { top: 10, right: 20, bottom: 10, left: 30}, label: 'coder2', x: -120, y: -20 },
	    	{ id: 5, font: { multi: true }, label: 'property1', x: 40, y: -40, color: 'rgb(255,168,7)' }, { id: 6, font: { multi: 'html', size: 20 }, label: 'property2', x: 40, y: 0, color: 'rgb(255,168,7)' },
        */
      ];
      
      //定义节点连接线
      var alledges = [
		    /*{ from: 1, to: 2, label: "single to default" },
        { from: 1, to: 3, font: { multi: true }, label: "default to <b>html</b>" },

        { from: 4, to: 5, font: { multi: "md" }, label: "*html* to _md_" }, { from: 4, to: 6, font: { multi: "md" }, label: "*html* to _md_" },
        */
      ];
	  
      // 创建节点对象
      var nodes = new vis.DataSet(allnodes);
      // 创建连线对象
      var edges = new vis.DataSet(alledges);

      var container = document.getElementById('mynetwork');
      var data = {
        nodes: nodes,
        edges: edges
      };
      var options = {
        edges: {
          font: {
            size: 12
          }
        },
        nodes: {
          shape: 'box',
          borderWidth: 2,//节点边框宽度设置
          borderWidthSelected: 4,
          font: {
            bold: {
              color: '#0077aa'
            }
          }
        },
        physics: {
          enabled: false
        },
        manipulation: {
          enabled: false,
          addNode: function(data, callback) {
			      callback(null);
            /*var idExist = true; // you can change it to false to see addition
            if (idExist) {
              callback(null);
              console.log('node exist!!!, not added');
            } else {
              callback(data);
            }*/
          },
          editNode: function(data, callback) {
            console.log('edit', data);
            callback(data);
          },
          addEdge: function(data, callback) {
            console.log('add edge!', data);
            callback(data);
          }
        }
      };
      var network = new vis.Network(container, data, options);
      network.on("click", function(params) {
        params.event = "[original event]";
        document.getElementById('eventSpan').innerHTML = '<h2>Click event:</h2>' + JSON.stringify(params, null, 4);
        console.log('click event, getNodeAt returns: ' + this.getNodeAt(params.pointer.DOM));
      });
      network.on("doubleClick", function(params) {
        params.event = "[original event]";
        document.getElementById('eventSpan').innerHTML = '<h2>doubleClick event:</h2>' + JSON.stringify(params, null, 4);
      });

      //for drag
      function allowDrop(ev) {
        ev.preventDefault();
      }

      function drag(ev) {
          ev.dataTransfer.setData("x", ev.offsetX);
          ev.dataTransfer.setData("y", ev.offsetY);
      }

      var dragNodeWidth = 40
      var dragNodeHeight = 20
      function drop(e) {
        e.preventDefault();
        //var data=ev.dataTransfer.getData("Text");
        //ev.target.appendChild(document.getElementById(data));

        var evt = e || event;

        width = document.getElementById("mynetwork").offsetWidth;
        height = document.getElementById("mynetwork").offsetHeight;
        
        var left = evt.offsetX - evt.dataTransfer.getData("x") - width / 2 + dragNodeWidth;
        var top = evt.offsetY - evt.dataTransfer.getData("y") - height / 2 + dragNodeHeight;
      
        var id = network.body.data.nodes.length + 1;
        node = {id: ""+id, text: "hello", x: left, y: top, depth: 0};
	      addNode(JSON.stringify(node));
      }
	
      function log(message) {
        if (Qt) {
          coderview.qt_log(message);
        } else {
          console.log(message);
        }
      }
  
      //===============to python==============
      function addNode(node) {
        try {
          log("=======addNode========"+node);
          node = JSON.parse(node)
          if (node.depth == 0) {
            network.body.data.nodes.add([{ id: node.id, font: { multi: 'html', size: 18 }, margin: { top: 5, right: 10, bottom: 5, left: 10 }, label: node.text, x: node.x, y: node.y, color: 'rgb(255,168,7)'}]);
          } else {
            network.body.data.nodes.add([{ id: node.id, font: { multi: true}, label: node.text, x: node.x, y: node.y, color: 'rgb(255,168,7)'}]);
          }
        } catch(err) {
          log("=======js error:========" + err);
        }
      }
  
      function addEdge(edge) {
        log("=======addEdge========"+edge);
        edge = JSON.parse(edge)
        network.body.data.edges.add([{id: edge.id, from: edge.from, to: edge.to}]);
      }

      // Wait for document ready event
      var Qt = false;
      $(document).ready(function() {
        // Check for Qt Integration
        if (typeof coderview != 'undefined') {
          coderview.qt_log("coder Qt Found!");
          Qt = true;
          coderview.page_ready();
        } else {
          console.log("Qt NOT Found!");
        }
      });
</script>

</html>